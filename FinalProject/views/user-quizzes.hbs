{{!--
  ============================================================
  user_quizzes.hbs — User-Quizzes M:M Page (CS340)
  Group 69 — Sasan Pourassef & Jeremy Dempsey
  Oregon State University

  Description:
    This file displays and manages the User_Quizzes junction
    table with CRUD operations:
      • READ: Display user-quiz relationships
      • CREATE: Form to assign users to quizzes
      • DELETE: Button to remove user-quiz associations

  Purpose:
    Manages many-to-many relationships between Users and
    Quizzes:
      1) Browse all user-quiz associations with usernames
      2) Assign users to quizzes they can take
      3) Remove user access to quizzes
      4) Dynamic dropdowns for user and quiz selection

  Note:
    Score and taken_at data are stored in the Quizzes table
    itself, not in this junction table (user_id, quiz_id only).
    
    Sources:
        • This file was created based on standard Handlebars
          layout practices and customized for the Study Application.

  ============================================================
--}}

<h1>User Quiz Attempts</h1>

<p class="page-description">
    Track quiz attempts by users, including scores and completion dates. View quiz history and performance.
</p>

{{! READ - Display all quiz attempts }}
<h2>Quiz Attempt History</h2>

{{#if attempts}}
<table>
    <thead>
        <tr>
            <th>Attempt ID</th>
            <th>User</th>
            <th>Quiz</th>
            <th>Score</th>
            <th>Date Taken</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {{#each attempts}}
        <tr>
            <td>{{this.user_id}}-{{this.quiz_id}}</td>
            <td>{{this.username}}</td>
            <td>{{this.quiz_title}}</td>
            <td>
                {{#if this.score}}
                    {{this.score}}%
                {{else}}
                    Not Scored
                {{/if}}
            </td>
            <td>{{this.attempt_date}}</td>
            <td>
                {{! DELETE form - will be functional in next step }}
                <form class="delete-form" method="POST" action="/delete-user-quiz/{{this.user_id}}/{{this.quiz_id}}">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn-delete">Delete Attempt</button>
                </form>
            </td>
        </tr>
        {{/each}}
    </tbody>
</table>
{{else}}
<p class="no-data">No quiz attempts recorded yet. Use the form below to add a quiz attempt.</p>
{{/if}}

{{! CREATE - Form to record quiz attempt }}
<h2>Record Quiz Attempt</h2>

<form class="cuForm" id="create-quiz-attempt-form" method="POST" action="/add-user-quiz">
    <label for="user_id">Select User:</label>
    <select name="user_id" id="user_id" required>
        <option value="" disabled selected>Choose a user...</option>
        {{#each users}}
        <option value="{{this.user_id}}">{{this.username}}</option>
        {{/each}}
    </select>

    <label for="quiz_id">Select Quiz:</label>
    <select name="quiz_id" id="quiz_id" required>
        <option value="" disabled selected>Choose a quiz...</option>
        {{#each quizzes}}
        <option value="{{this.quiz_id}}">Quiz #{{this.quiz_id}}</option>
        {{/each}}
    </select>

    <button type="submit" class="btn-submit">Record Quiz Attempt</button>
</form>

<h2>Update Question Order (UPDATE M:N) ⭐</h2>

<form class="cuForm" id="update-order-form" method="POST" action="/update-quiz-flashcard">
    <label for="update_quiz_id">Select Quiz-Flashcard:</label>
    <select name="quiz_id" id="update_quiz_id" required onchange="updateCardId()">
        <option value="" disabled selected>Choose a quiz-flashcard...</option>
        {{#each assignments}}
        <option value="{{this.quiz_id}}" data-card-id="{{this.card_id}}" data-order="{{this.question_order}}">
            Quiz #{{this.quiz_id}} - {{this.front_text}} (Current Order: {{this.question_order}})
        </option>
        {{/each}}
    </select>

    <input type="hidden" name="card_id" id="update_card_id" />

    <label for="update_question_order">New Question Order:</label>
    <input type="number" name="question_order" id="update_question_order" min="1" required placeholder="Enter new order number" />

    <button type="submit" class="btn-update">Update Order</button>
</form>

<script>
function updateCardId() {
    const select = document.getElementById('update_quiz_id');
    const selectedOption = select.options[select.selectedIndex];
    const cardId = selectedOption.getAttribute('data-card-id');
    document.getElementById('update_card_id').value = cardId;
}
</script>