<div class="page-container">
    <h2>Quizzes Management</h2>
    <p class="page-description">Manage quiz attempts and track student performance.</p>

    {{!-- Add New Quiz Form --}}
    <div class="form-section">
        <h3>Create New Quiz</h3>
        <form id="add-quiz-form" method="POST" action="/add-quiz">
            <div class="form-group">
                <label for="user_id">Quiz Taker (User):</label>
                <select id="user_id" name="user_id" required>
                    <option value="">-- Select User --</option>
                    {{#each users}}
                    <option value="{{this.user_id}}">{{this.username}}</option>
                    {{/each}}
                </select>
                <small>Who is taking this quiz?</small>
            </div>

            <div class="form-group">
                <label for="score">Score:</label>
                <input type="number" id="score" name="score" min="0" max="100" step="0.01">
                <small>Leave blank if quiz is not yet graded (0-100)</small>
            </div>

            <div class="form-group">
                <label for="attempt_date">Attempt Date:</label>
                <input type="datetime-local" id="attempt_date" name="attempt_date" required>
            </div>

            <button type="submit" class="btn btn-primary">Create Quiz</button>
        </form>
    </div>

    {{!-- Browse Quizzes Table --}}
    <div class="table-section">
        <h3>Quiz History</h3>
        <table id="quizzes-table">
            <thead>
                <tr>
                    <th>Quiz ID</th>
                    <th>User</th>
                    <th>Score</th>
                    <th>Attempt Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{#each data}}
                <tr data-quiz-id="{{this.quiz_id}}">
                    <td>{{this.quiz_id}}</td>
                    <td>{{this.taker_name}}</td>
                    <td>
                        {{#if this.score}}
                            <span class="score-badge" data-score="{{this.score}}">
                                {{this.score}}%
                            </span>
                        {{else}}
                            <span class="score-badge score-pending">Not Graded</span>
                        {{/if}}
                    </td>
                    <td>{{this.attempt_date}}</td>
                    <td>
                        <button class="btn btn-small btn-edit" onclick="showUpdateForm({{this.quiz_id}})">Edit</button>
                        <button class="btn btn-small btn-delete" onclick="deleteQuiz({{this.quiz_id}})">Delete</button>
                    </td>
                </tr>
                {{/each}}
                {{#unless data}}
                <tr>
                    <td colspan="5" style="text-align: center;">No quizzes found. Create one to get started!</td>
                </tr>
                {{/unless}}
            </tbody>
        </table>
    </div>

    {{!-- Update Quiz Form (Hidden by default) --}}
    <div id="update-quiz-section" class="form-section" style="display: none;">
        <h3>Update Quiz</h3>
        <form id="update-quiz-form">
            <input type="hidden" id="update-quiz-id" name="quiz_id">
            
            <div class="form-group">
                <label for="update-user-id">Quiz Taker (User):</label>
                <select id="update-user-id" name="user_id" required>
                    <option value="">-- Select User --</option>
                    {{#each users}}
                    <option value="{{this.user_id}}">{{this.username}}</option>
                    {{/each}}
                </select>
            </div>

            <div class="form-group">
                <label for="update-score">Score:</label>
                <input type="number" id="update-score" name="score" min="0" max="100" step="0.01">
                <small>Enter score between 0-100</small>
            </div>

            <button type="submit" class="btn btn-primary">Update Quiz</button>
            <button type="button" class="btn btn-secondary" onclick="cancelUpdate()">Cancel</button>
        </form>
    </div>
</div>

<style>
/* Score badge styling */
.score-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 700;
}

.score-pending {
    background-color: #e2e3e5;
    color: #383d41;
}
</style>

<script>
// Color code scores after page loads
document.addEventListener('DOMContentLoaded', function() {
    // Color code all score badges based on value
    document.querySelectorAll('.score-badge[data-score]').forEach(function(badge) {
        const score = parseFloat(badge.getAttribute('data-score'));
        
        if (score >= 90) {
            badge.style.backgroundColor = '#d4edda';
            badge.style.color = '#155724';
        } else if (score >= 80) {
            badge.style.backgroundColor = '#cce5ff';
            badge.style.color = '#004085';
        } else if (score >= 70) {
            badge.style.backgroundColor = '#fff3cd';
            badge.style.color = '#856404';
        } else {
            badge.style.backgroundColor = '#f8d7da';
            badge.style.color = '#721c24';
        }
    });
});

// Show update form with quiz data
function showUpdateForm(quizId) {
    fetch('/quizzes/' + quizId)
        .then(response => response.json())
        .then(data => {
            document.getElementById('update-quiz-id').value = data.quiz_id;
            document.getElementById('update-user-id').value = data.user_id;
            document.getElementById('update-score').value = data.score || '';
            
            // Show the update form
            document.getElementById('update-quiz-section').style.display = 'block';
            document.getElementById('update-quiz-section').scrollIntoView({ behavior: 'smooth' });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading quiz data');
        });
}

// Cancel update
function cancelUpdate() {
    document.getElementById('update-quiz-section').style.display = 'none';
    document.getElementById('update-quiz-form').reset();
}

// Handle update form submission
document.getElementById('update-quiz-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    let formData = {
        quiz_id: document.getElementById('update-quiz-id').value,
        user_id: document.getElementById('update-user-id').value,
        score: document.getElementById('update-score').value || null
    };
    
    fetch('/update-quiz', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (response.ok) {
            alert('Quiz updated successfully!');
            location.reload();
        } else {
            alert('Error updating quiz');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating quiz');
    });
});

// Delete quiz
function deleteQuiz(quizId) {
    if (confirm('Are you sure you want to delete this quiz?')) {
        fetch('/delete-quiz/' + quizId, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                alert('Quiz deleted successfully!');
                document.querySelector(`tr[data-quiz-id="${quizId}"]`).remove();
            } else {
                alert('Error deleting quiz');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting quiz');
        });
    }
}

// Set current datetime for attempt_date field
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('attempt_date').value = now.toISOString().slice(0, 16);
});
</script>
