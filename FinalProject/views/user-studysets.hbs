{{!--
  ============================================================
  user_studysets.hbs — User-StudySets M:M Page (CS340)
  Group 69 — Sasan Pourassef & Jeremy Dempsey
  Oregon State University

  Description:
    This file displays and manages the User_StudySets junction
    table with full CRUD operations:
      • READ: Display user-studyset relationships with roles
      • CREATE: Form to assign users to study sets
      • UPDATE: Form to modify user roles within study sets
      • DELETE: Button to remove user-studyset associations

  Purpose:
    Manages many-to-many relationships between Users and
    StudySets:
      1) Browse all user-studyset associations with usernames
      2) Assign users to study sets with roles (Owner/Viewer)
      3) Update user roles within study sets
      4) Remove user access to study sets
      5) Dynamic dropdowns for user and studyset selection
    
    Sources:
        • This file was created based on standard Handlebars
          layout practices and customized for the Study Application.

  ============================================================
--}}

<h1>User Study Sets - Shared Access</h1>

<p class="page-description">
    Manage which users have access to which study sets. Share study sets with other users to collaborate.
</p>

{{! READ - Display all user-studyset relationships }}
<h2>Current Shared Study Sets</h2>

{{#if relationships}}
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>User</th>
            <th>Study Set</th>
            <th>Shared Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {{#each relationships}}
        <tr>
            <td>{{this.user_id}}-{{this.set_id}}</td>
            <td>{{this.username}}</td>
            <td>{{this.studyset_title}}</td>
            <td>{{this.shared}}</td>
            <td>
                {{! DELETE form - will be functional in next step }}
                <form class="delete-form" method="POST" action="/delete-user-studyset/{{this.user_id}}/{{this.set_id}}">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn-delete">Remove Access</button>
                </form>
            </td>
        </tr>
        {{/each}}
    </tbody>
</table>
{{else}}
<p class="no-data">No shared study sets yet. Use the form below to share a study set with a user.</p>
{{/if}}

{{! CREATE - Form to share study set with user }}
<h2>Share Study Set with User</h2>

<form class="cuForm" id="share-studyset-form" method="POST" action="/add-user-studyset">
    <label for="user_id">Select User:</label>
    <select name="user_id" id="user_id" required>
        <option value="" disabled selected>Choose a user...</option>
        {{#each users}}
        <option value="{{this.user_id}}">{{this.username}}</option>
        {{/each}}
    </select>

    <label for="set_id">Select Study Set:</label>
    <select name="set_id" id="set_id" required>
        <option value="" disabled selected>Choose a study set...</option>
        {{#each studysets}}
        <option value="{{this.set_id}}">{{this.title}}</option>
        {{/each}}
    </select>
    
    <label for="role">Role:</label>
    <select name="role" id="role" required>
        <option value="viewer">Viewer</option>
        <option value="editor">Editor</option>
    </select>

    <button type="submit" class="btn-submit">Share Study Set</button>
</form>

{{! UPDATE - Not typically needed for junction tables }}
<h2>Note</h2>
<p class="info-note">
    To modify access, remove the existing relationship and create a new one if needed.
</p>
<h2>Update User Role (UPDATE M:N) ⭐</h2>


<form class="cuForm" id="update-role-form" method="POST" action="/update-user-studyset">
    <label for="update_user_id">Select User-Set Relationship:</label>
    <select name="user_id" id="update_user_id" required onchange="updateSetId()">
        <option value="" disabled selected>Choose a relationship...</option>
        {{#each relationships}}
        <option value="{{this.user_id}}" data-set-id="{{this.set_id}}" data-role="{{this.role}}">
            {{this.username}} → {{this.studyset_title}} (Current: {{this.role}})
        </option>
        {{/each}}
    </select>

    <input type="hidden" name="set_id" id="update_set_id" />

    <label for="update_role">New Role:</label>
    <select name="role" id="update_role" required>
        <option value="viewer">Viewer</option>
        <option value="editor">Editor</option>
    </select>

    <button type="submit" class="btn-update">Update Role</button>
</form>

<script>
function updateSetId() {
    const select = document.getElementById('update_user_id');
    const selectedOption = select.options[select.selectedIndex];
    const setId = selectedOption.getAttribute('data-set-id');
    document.getElementById('update_set_id').value = setId;
}
</script>